{% extends "base.html" %}
{% block body %}
<div id="spinner" class="spinner" style="display:none;">
    <img id="img-spinner" src="/static/images/ajax-loader.gif" alt="Loading"/>
</div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
          Search Options
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse collapse in">
      <div class="panel-body">
        
<ul class="nav nav-tabs" id="myTab">
  <li class= "active" href="#rocktypes"><a href="#rocktypes">Rock Types</a></li>
  <li><a href="#metgrade">Metamorphic Grade</a></li>
  <li><a id = "location-tab" href="#location">Location</a></li>
  <li><a href="#minerals">Minerals</a></li>
  <li><a href="#chemistry">Chemistry</a></li>
  <li><a href="#provenance">Provenance</a></li>
</ul>
<div id = "form-container">
    <form action="" method="get" id='content' class="tab-content">
      <div class="tab-pane active" id="rocktypes">
        <ul>
         <h3>Rock Types</h3>
         <div id="rocktypelist">
         {% for rock_type in rock_types %}
         <input type="checkbox" class="rocktype" onchange="updateRockTypes()"  name="rock_type__rock_type__in"         
         value="{{rock_type.rock_type}}">{{ rock_type.rock_type }}
         {% endfor %}

         <br><br>
         </div><!-- control-group-->
        </ul>
      </div><!-- rocktypes -->
      
      <div class="tab-pane" id="metgrade">
        <ul>
         <h3>Metamorphic Grade</h3>
         <div id = "metgrade-checkboxes">
         {% for grade in metamorphic_grades %}
         <input type="checkbox" class = "metgrade" onchange="updateMetGrades()"
  name="metamorphic_grades__name__in" value="{{ grade }}">
         {{ grade }}
         {% endfor %}
         </div><!-- metgrade checkboxes -->
        </ul>
      </div>
      
      <div class="tab-pane" id="location">
       <ul>
        <h3>Location</h3>
        <div id="map-canvas"></div>
        <p id ="map-instructions">Draw a selection on the map to toggle coordinates below.</p><br>
        <label for="bounds">NE Lat: </label>
        <input type="text" onchange="updateBounds()" placeholder="Enter lat/long value" id="ne-lat" class="latlong" > 
        
        <label for="bounds">NE Long: </label>
        <input type="text" onchange="updateBounds()" placeholder="Enter lat/long value" id="ne-long" class="latlong" ><br>

        <label for="bounds">SW Long: </label>
        <input type="text" onchange="updateBounds()" placeholder="Enter lat/long value" id="sw-lat" class="latlong" > 

        <label for="bounds">SW Long: </label>
        <input type="text" onchange="updateBounds()" placeholder="Enter lat/long value" id="sw-long" class="latlong" ><br><br>

<input type="hidden" id="ne-location-bound" name="location__contained" value="">
<!-- <input type="hidden" id="sw-location-bound" name="samples__location__contained" value=""> -->


        <div id = "location-regions"
        <label for="regions__name">Regions: </label><br>
        <select name="regions__name">
        <option value="" selected="selected">Regions</option>
        {% for region in regions %}
             <option value="{{ region }}">{{ region }}</option>
        {% endfor %}
        </select>
        <br>
        <label for="metamophic_regions__name">Metamorphic Regions: </label><br>
        <select name="metamorphic_regions__name">
        <option value="" selected="selected">Metamorphic Regions</option>
        {% for region in metamorphic_regions %}
             <option value="{{ region }}">{{ region }}</option>
        {% endfor %}
        </select>
        </div> <!-- end location-regions -->
       </ul>
      </div>
      
      <div class="tab-pane" id="minerals">
      </div>

      <div class="tab-pane" id="chemistry">
      </div>

      <div class="tab-pane" id="provenance">
       <ul id = "provenance">
        <h3>Provenance</h3>
        <label class="provenance-label" for="owner">Owner: </label>
        <select multiple name="owner" class="chosen-select">
        {% for o in owners %}
            <option value="{{ o }}">{{ o }}</option>
        {% endfor %}
        </select><br>
        <label class="provenance-label" for="collector">Collector: </label>
        <select multiple name="collector__in" class="chosen-select">
        {% for col in provenances %}
            <option value="{{ col }}">{{ col }}</option>
        {% endfor %}
        </select><br>
        <label class="provenance-label" for="references__name__in">Reference: </label>
        <select multiple class="chosen-select" name="references__name__in">
        {% for ref in references %}
            <option value="{{ ref }}">{{ ref }}</option>
        {% endfor %}
        </select><br>
        <label class="provenance-label" for="samples__number">Number: </label>
        <select name="number" class="chosen-select">
        <option value="">Select sample number</option>
        {% for n in numbers %}
            <option value="{{ n }}">{{ n }}</option>
        {% endfor %}
        </select><br>
        <label class="provenance-label" for="igsn">IGSN: </label>
        <select name="igsn" class="chosen-select">
        <option value="">Select IGSN</option>
        {% for i in isgns %}
            <option value="{{ i }}">{{ i }}</option>
        {% endfor %}
        </select><br>
<label class="provenance-label" for="dates">Date Range: </label><input type="text" name="dates" id="date-start"> to <input type="text" name="dates" id="date-end"><br>
       </ul>
      </div>

      <div id = "form-submit">
       <input type="radio" name="resource" value="sample" checked>Sample<br>
       <input type="radio" name="resource" value="chemicalanalysis">Chemical Analysis<br><br>
       <input type="submit" value="Search">
      </div>
  </form>  <!-- tabs -->

<div class="clear"></div>

<div id="search-summary" class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
          Search Summary
        </a>
      </h4>
    </div>
    <div id="collapseTwo" class="panel-collapse collapse in">
      <div class="panel-body">
      <div id = "search-options-rock-type"></div>
      <div id = "search-options-metgrades"></div>
      </div>
</div><!--end collapsetwo -->
</div>


</div><!--end form container-->
  {% if error %}
      <p style="color: red;">Please submit a search term.</p>
  {% endif %}
      </div>
    </div>
  </div>

<div id = "results"></div>


<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=drawing"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="/static/css/chosen.min.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="/static/js/chosen.jquery.min.js"></script>

<script>
$('#myTab a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
});

//GLOBAL VARS
var currentOverlay;

//ON READY FUNCTION
$(function()
{
 //Group rock types
 var originalHTML = $("#rocktypelist :input");
 var newInnerHTML = '';
 var a;
 var b = 0;
 var div;
 var rocktypes = document.createElement('div');

 for (a = 0; a < originalHTML.length; a++)
 {
  if(b == 0)
  {
   div = document.createElement('div');
   div.className = 'rocktypecheckboxgroup';
  }
  var input = document.createElement('input');
  $(input).className = "rocktype";
  $(input).attr('type','checkbox');
  $(input).attr('onchange','updateRockTypes()');
  $(input).attr('name','rock_type__rock_type__in');
  var val = $(originalHTML[a]).attr('value');
  $(input).attr('value', val);

 
  div.appendChild(input);
  div.innerHTML += val += "<br>";

  if(b == 4 || a == originalHTML.length - 1)
  {
   rocktypes.appendChild(div);
   b = 0;
  }
  else
   b++;
 }
 document.getElementById('rocktypelist').innerHTML = '';
 document.getElementById('rocktypelist').appendChild(rocktypes);

//Group metamorphic grades
 originalHTML = $("#metgrade-checkboxes :input");
 newInnerHTML = '';
 b = 0;
 var metgrades = document.createElement('div');

 for (a = 0; a < originalHTML.length; a++)
 {
  if(b == 0)
  {
   div = document.createElement('div');
   div.className = 'metgradecheckboxgroup';
  }
  var input = document.createElement('input');
  $(input).className = "metgrade";
  $(input).attr('type','checkbox');
  $(input).attr('onchange','updateMetGrades()');
  $(input).attr('name','metamorphic_grades__name__in');
  var val = $(originalHTML[a]).attr('value');
  $(input).attr('value', val);

  div.appendChild(input);
  div.innerHTML += val += "<br>";

  if(b == 4 || a == originalHTML.length - 1)
  {
   metgrades.appendChild(div);
   b = 0;
  }
  else
   b++;
 }
 document.getElementById('metgrade-checkboxes').innerHTML = '';
 document.getElementById('metgrade-checkboxes').appendChild(metgrades);


//GOOGLE MAP RENDERING
function initialize()
{
 var map = new google.maps.Map(document.getElementById('map-canvas'), {
    zoom: 11,
    center: new google.maps.LatLng(40.710836, -74.019889),
    mapTypeId: google.maps.MapTypeId.ROADMAP
 });

 google.maps.event.addListenerOnce(map, 'idle', function() {
    google.maps.event.trigger(map, 'resize');
});

//SET UP DRAWING MANAGER
var drawingManager = new google.maps.drawing.DrawingManager({
  drawingMode: google.maps.drawing.OverlayType.MARKER,
  drawingControl: true,
  drawingControlOptions: {
    position: google.maps.ControlPosition.TOP_CENTER,
    drawingModes: [
      google.maps.drawing.OverlayType.RECTANGLE
    ]
  },
  circleOptions: {
    fillColor: '#ffff00',
    fillOpacity: 1,
    strokeWeight: 5,
    clickable: false,
    zIndex: 1,
    editable: true
  }
}); //end drawing manager  

drawingManager.setMap(map); 

currentOverlay = new google.maps.Rectangle({
    bounds: null,
    editable: true,
    draggable: true
  });

  currentOverlay.setMap(map);


//DRAW COMPLETE LISTENER
google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
  if (event.type == google.maps.drawing.OverlayType.RECTANGLE) {
  {
   //Set draggable and editable
   event.overlay.setEditable(true);
   event.overlay.setDraggable(true);

   //Remove last overlay
   if(currentOverlay)
    currentOverlay.setMap(null);

   //Set current overlay
   currentOverlay = event.overlay;

   //Update bounds for drag and edit
   google.maps.event.addListener(currentOverlay, "bounds_changed", function() 
   {
   var ne = event.overlay.getBounds().getNorthEast();
   var sw = event.overlay.getBounds().getSouthWest();
   document.getElementById("ne-lat").value = ne.lat().toString();
   document.getElementById("ne-long").value = ne.lng().toString();
   document.getElementById("sw-lat").value = sw.lat().toString();
   document.getElementById("sw-long").value = sw.lng().toString();
   });

   //Update bounds for creation
   var ne = event.overlay.getBounds().getNorthEast();
   var sw = event.overlay.getBounds().getSouthWest();
   document.getElementById("ne-lat").value = ne.lat().toString();
   document.getElementById("ne-long").value = ne.lng().toString();
   document.getElementById("sw-lat").value = sw.lat().toString();
   document.getElementById("sw-long").value = sw.lng().toString();

   //Update POINT 4326 values to submit
   //SRID=4326;POINT(-118.0488106 33.9346343)
   //var upperbound = 'SRID=4326;POINT(' + ne.lat().toString() + ' ' +  ne.lng().toString() + ')';
   //var lowerbound = 'SRID=4326;POINT(' + sw.lat().toString() + ' ' +  sw.lng().toString() + ')';

//   var upperbound = "{\"type\": \"Point\", \"coordinates\": [" + ne.lat().toString() + "," + ne.lng().toString() + "]}";
//   var lowerbound = "{\"type\": \"Point\", \"coordinates\": [" + sw.lat().toString() + "," + sw.lng().toString() + "]}";
  
  //POINT (-71.8552169799804972 44.0474815368651988)
  //var upperbound = "POINT(" + ne.lat().toString() + " " + ne.lng().toString() + ")";
  //var lowerbound = "POINT(" + sw.lat().toString() + " " + sw.lng().toString() + ")";
  
 /*
 { "type": "Polygon",
    "coordinates": [
      [ [100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0], [100.0, 0.0] ]
      ]
   }
 */

  //http://stackoverflow.com/questions/15536241/how-to-get-4-vertex-coordinates-from-gmaps-rectangle-overlay
  var nw = new google.maps.LatLng(ne.lat(),sw.lng());
  var se = new google.maps.LatLng(sw.lat(),ne.lng());
  var polygon =  "{ \"type\": \"Polygon\", \"coordinates\": [[" + ne.lat().toString() + "," + ne.lng().toString() +"] , [" + se.lat().toString() + ", " + se.lng().toString() + "] , [" + sw.lat().toString() + "," + sw.lng().toString() +"] , [" + nw.lat().toString() + "," + nw.lng().toString() + "]]}";


   //document.getElementById("ne-location-bound").value = upperbound;
   //document.getElementById("sw-location-bound").value = lowerbound;
   document.getElementById("ne-location-bound").value = polygon;
   console.log(polygon);
   //console.log(upperbound);
   //console.log( lowerbound);

  }

  }
});
}

//Initialize map listener
google.maps.event.addDomListener(document.getElementById("location-tab"), 'click', initialize);

//Date picker
$( "#date-start" ).datepicker();
$( "#date-end" ).datepicker();

//Chosen-select plugin activate
$(".chosen-select").chosen({
    disable_search_threshold: 10,
    no_results_text: "Oops, nothing found!",
    width: "50%"
  });

//Ajax call to update sample data
var frm = $('#content');
    frm.submit(function () {
    $('#spinner').show();
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            success: function (data) {
                $("#results").html(data);
                $('#spinner').hide();
            },
            error: function(data) {
                $("#results").html("Error");
                $('#spinner').hide();
            }
        });
        return false;
    }); //END ajax

//Update search summary
$('.provenance').keyup(function() {
   $('#CFName').val($(this).val());
});

}); //END READY FUNCTION

//UPDATE BOUNDS
function updateBounds()
{
  var nelat = document.getElementById("ne-lat").value;
  var nelong = document.getElementById("ne-long").value;
  var swlat = document.getElementById("sw-lat").value;
  var swlong = document.getElementById("sw-long").value;
  currentOverlay.setBounds(new google.maps.LatLngBounds(
      new google.maps.LatLng(nelat, nelong),
      new google.maps.LatLng(swlat, swlong)
  ));

   //Update POINT 4326 values to submit
   //SRID=4326;POINT(-118.0488106 33.9346343)
   //var upperbound = 'SRID=4326;POINT(' + nelat + ' ' +  nelong + ')';
   //var lowerbound = 'SRID=4326;POINT(' + swlat + ' ' +  swlong + ')';
   var upperbound = "{'type': 'Point', 'coordinates': [" + nelat + "," + nelong + "]}";
   var lowerbound = "{'type': 'Point', 'coordinates': [" + swlat + "," + swlong + "]}";

   document.getElementById("ne-location-bound").value = upperbound;
   document.getElementById("sw-location-bound").value = lowerbound;
   console.log(upperbound);
   console.log( lowerbound);
}

//UPDATE SUMMARY
function updateRockTypes()
{
 //Update Rock Types
 document.getElementById("search-options-rock-type").innerHTML = "";
 var checkBoxes = document.getElementsByName("rock_type__rock_type__in");
 document.getElementById("search-options-rock-type").innerHTML += "<h4>Rock Types</h4>";

 for(var i=0; i < checkBoxes.length;i++)
 { 
  if(checkBoxes[i].checked)
  {         
   console.log(checkBoxes[i].defaultValue);
   document.getElementById("search-options-rock-type").innerHTML += checkBoxes[i].defaultValue + ", ";
  }
 }
 document.getElementById("search-options-rock-type").innerHTML += "<a onclick='clearRockTypes()'>Clear</a>";
}

function updateMetGrades()
{
//Update Metamorphic Grades
 document.getElementById("search-options-metgrades").innerHTML = "";
 checkBoxes = document.getElementsByName("metamorphic_grades__name__in");
 console.log(checkBoxes);
 document.getElementById("search-options-metgrades").innerHTML += "<h4>Metamorphic Grades</h4>";

 for(var i=0; i < checkBoxes.length;i++)
 { 
  if(checkBoxes[i].checked)
  {         
   console.log(checkBoxes[i].defaultValue);
   document.getElementById("search-options-metgrades").innerHTML += checkBoxes[i].defaultValue + ", ";
  }
 }
 document.getElementById("search-options-metgrades").innerHTML += "<a onclick='clearMetGrades()'>Clear</a>";
}

function clearRockTypes()
{
 var checkBoxes = document.getElementsByName("rock_type__rock_type__in");
 for(var i=0; i < checkBoxes.length;i++)
 { 
 checkBoxes[i].checked = false;
 }
 document.getElementById("search-options-rock-type").innerHTML = "";
}

function clearMetGrades()
{
 var checkBoxes = document.getElementsByName("metamorphic_grades__name__in");
 for(var i=0; i < checkBoxes.length;i++)
 { 
 checkBoxes[i].checked = false;
 }
 document.getElementById("search-options-metgrades").innerHTML = "";
}
</script>

{% endblock %}
